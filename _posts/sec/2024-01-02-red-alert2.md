---
layout:		post
category:	"sec"
title:		"RA2红色警戒红警2"

tags:		[]
---
- Content
{:toc}
# 地图全开

2024年1月3日：已验证可行性。

```assembly
00481F9D  |> \0FBF56 26     movsx   edx, word ptr [esi+26]
00481FA1  |.  0FBF46 24     movsx   eax, word ptr [esi+24]
00481FA5  |.  52            push    edx
00481FA6  |.  50            push    eax
00481FA7  |.  68 10D08100   push    0081D010                         ;  ASCII "Crate at %d,%d contains 'reveal'",LF
00481FAC  |.  E8 2F49F8FF   call    004068E0                         ;  空函数
00481FB1  |.  8B4D 08       mov     ecx, dword ptr [ebp+8]
00481FB4  |.  83C4 0C       add     esp, 0C
00481FB7  |.  8B91 1C020000 mov     edx, dword ptr [ecx+21C]
00481FBD  |.  B9 E8F78700   mov     ecx, 0087F7E8
00481FC2  |.  52            push    edx
00481FC3  |.  E8 C85D0F00   call    00577D90                         ;  地图全开
```



```assembly
;只开全图的汇编代码
pushad
mov eax,0x00A83D4C
mov edx,[eax]
mov ecx,0x0087F7E8
push edx
mov eax,0x00577D90
call eax
popad
ret
```



```c
// 全地图内联代码
void Map_Assemble() {
	_asm {
		pushad
		mov eax,0x00A83D4C
		mov edx,[eax]
		mov ecx,0x0087F7E8
		push edx
		mov eax,0x00577D90
		call eax
		popad                      
	}
}
```



# 雷达开启

2024年1月3日：未验证可行性，仅作过程分析的参考。

```assembly
00656DF0  /$  53            push    ebx
00656DF1  |.  8B5C24 08     mov     ebx, dword ptr [esp+8]
00656DF5  |.  56            push    esi
00656DF6  |.  8BF1          mov     esi, ecx
00656DF8  |.  389E D8140000 cmp     byte ptr [esi+14D8], bl
00656DFE  |.  74 45         je      short 00656E45
00656E00  |.  84DB          test    bl, bl
00656E02  |.  889E D8140000 mov     byte ptr [esi+14D8], bl
00656E08  |.  B8 E8948300   mov     eax, 008394E8                    ;  ASCII "on"
00656E0D  |.  75 05         jnz     short 00656E14
00656E0F  |.  B8 E4948300   mov     eax, 008394E4                    ;  ASCII "off"
00656E14  |>  50            push    eax
00656E15  |.  68 BC948300   push    008394BC                         ;  ASCII "Radar: TacticalMap availability is %s",LF
00656E1A  |.  E8 C1FADAFF   call    004068E0
00656E1F  |.  8B86 B0140000 mov     eax, dword ptr [esi+14B0]
00656E25  |.  83C4 08       add     esp, 8
00656E28  |.  83F8 01       cmp     eax, 1
00656E2B  |.  6A 01         push    1
00656E2D  |.  75 0D         jnz     short 00656E3C
00656E2F  |.  53            push    ebx
00656E30  |.  8BCE          mov     ecx, esi
00656E32  |.  E8 A9FDFFFF   call    00656BE0
00656E37  |.  5E            pop     esi
00656E38  |.  5B            pop     ebx
00656E39  |.  C2 0400       retn    4
00656E3C  |>  6A 01         push    1
00656E3E  |.  8BCE          mov     ecx, esi
00656E40  |.  E8 6BFEFFFF   call    00656CB0
00656E45  |>  5E            pop     esi
00656E46  |.  5B            pop     ebx
00656E47  \.  C2 0400       retn    4




00656BE0  /$  8A4424 04     mov     al, byte ptr [esp+4]
00656BE4  |.  56            push    esi
00656BE5  |.  3C 01         cmp     al, 1
00656BE7  |.  8BF1          mov     esi, ecx
00656BE9  |.  75 5D         jnz     short 00656C48
00656BEB  |.  8B86 AC140000 mov     eax, dword ptr [esi+14AC]
00656BF1  |.  85C0          test    eax, eax
00656BF3  |.  74 09         je      short 00656BFE
00656BF5  |.  83F8 02       cmp     eax, 2
00656BF8  |.  0F85 91000000 jnz     00656C8F
00656BFE  |>  8D8E C0140000 lea     ecx, dword ptr [esi+14C0]
00656C04  |.  C786 AC140000>mov     dword ptr [esi+14AC], 3
00656C0E  |.  E8 4DF4DAFF   call    00406060
00656C13  |.  8A4424 0C     mov     al, byte ptr [esp+C]
00656C17  |.  84C0          test    al, al
00656C19  |.  74 1C         je      short 00656C37
00656C1B  |.  A1 E0718800   mov     eax, dword ptr [8871E0]
00656C20  |.  6A 00         push    0
00656C22  |.  BA 00200000   mov     edx, 2000
00656C27  |.  68 0000803F   push    3F800000
00656C2C  |.  8B88 F0060000 mov     ecx, dword ptr [eax+6F0]
00656C32  |.  E8 E99C0F00   call    00750920
00656C37  |>  68 A8948300   push    008394A8                         ;  ASCII "Radar: ACTIVATING",LF
00656C3C  |.  E8 9FFCDAFF   call    004068E0
00656C41  |.  83C4 04       add     esp, 4
00656C44  |.  5E            pop     esi
00656C45  |.  C2 0800       retn    8
00656C48  |>  8D8E C0140000 lea     ecx, dword ptr [esi+14C0]
00656C4E  |.  E8 0DF4DAFF   call    00406060
00656C53  |.  8A4424 0C     mov     al, byte ptr [esp+C]
00656C57  |.  C786 AC140000>mov     dword ptr [esi+14AC], 2
00656C61  |.  84C0          test    al, al
00656C63  |.  74 1D         je      short 00656C82
00656C65  |.  8B0D E0718800 mov     ecx, dword ptr [8871E0]
00656C6B  |.  6A 00         push    0
00656C6D  |.  BA 00200000   mov     edx, 2000
00656C72  |.  68 0000803F   push    3F800000
00656C77  |.  8B89 F4060000 mov     ecx, dword ptr [ecx+6F4]
00656C7D  |.  E8 9E9C0F00   call    00750920
00656C82  |>  68 94948300   push    00839494                         ;  ASCII "Radar: DEACTIVING",LF
00656C87  |.  E8 54FCDAFF   call    004068E0
00656C8C  |.  83C4 04       add     esp, 4
00656C8F  |>  5E            pop     esi
00656C90  \.  C2 0800       retn    8
```



https://github.com/OmniBlade/Chronoshift/blob/555338b7a850ba467d8b1b608f5705b8a47a6c27/src/game/engine/radar.cpp#L759



```
enum RadarStateType
{
    RADAR_M1 = -1, // Toggle active and inactive
    RADAR_0 = 0, // Turn radar off
    RADAR_1 = 1, // Turn radar on
    RADAR_2 = 2, // Radar off no side bar.
    RADAR_3 = 3, // Radar on no side bar
    RADAR_4 = 4, // Remove radar
};
```



```assembly
;开全图加开雷达

;nop掉以下指令
00656BE9   75 5D    jnz     short 00656C48                   ;  nop掉

;注入以下代码：
pushad
mov dword ptr ds:[0xBAD3E8],1
mov esi,0087F7E8
mov dword ptr ds:[esi+0x14AC],0x3
mov ecx,0x00A83D4C
mov edx,dword ptr ds:[ecx+0x21C]
mov ecx,0087F7E8
push edx
call 00577d90
popad
ret
```



```c
BOOL TrainerFunctions::RadarOn() //总是有雷达 
{
	const DWORD address[2] = {0x00A8B230,0x34A4};
	DWORD add;
	if(!readAddress(address,2,&add))
		return FALSE;
	writeMemory(add,0x1,0x1);
	return TRUE;
}
```

验证：

- 对 00577D90 函数下断点，创建雷达后断下来跟踪
- **0A83D4C** 是个很重要的角色基址，与后面实现控制对方有关。
- 

参考：

- https://github.com/AdjWang/RA2YurisRevengeTrainer
- [Ra2辅助制作（1）](https://blog.csdn.net/qq_41252520/article/details/97514511)
